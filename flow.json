    {
      "id": "AGENDA_DNI",
      "type": "input",
      "text": "Por favor, ingresa tu c√©dula (10 d√≠gitos) o pasaporte:",
      "validation": "dni",
      "save_as": "agenda.dni",
      "hooks": [
        {
          "hook": "patient.lookup",
          "args": ["{agenda.dni}"],
          "if_true_next": "AGENDA_EXISTE_DIA",
          "if_false_next": "AGENDA_NEW_NAME"
        }
      ]
      },
      {
        "id": "AGENDA_EXISTE_DIA",
        "type": "choice",
        "text": "Bienvenido/a {agenda.patient.name}. Indique qu√© d√≠a desea ser atendido‚Ä¶",
        "options": [
          { "key": "1", "label": "Hoy", "hooks": [{ "hook": "dates_today", "save_as": "agenda.date" }], "next": "AGENDA_SEDE" },
          { "key": "2", "label": "Ma√±ana", "hooks": [{ "hook": "dates_tomorrow", "save_as": "agenda.date" }], "next": "AGENDA_SEDE" },
          { "key": "3", "label": "Otra fecha", "next": "AGENDA_INPUT_FECHA" },
          { "key": "0", "label": "Atr√°s", "command": "back" },
          { "key": "9", "label": "Inicio", "command": "home" }
        ]
      },
    {
      "id": "AGENDA_NEW_NAME",
      "type": "input",
      "text": "Escriba un nombre y dos apellidos (ej: Maria Lopez Garcia)",
      "validation": "fullname",
      "save_as": "agenda.full_name",
      "next": "AGENDA_NEW_BIRTHDATE"
    },
    {
      "id": "AGENDA_NEW_BIRTHDATE",
      "type": "input",
      "text": "Digite su fecha de nacimiento (DD-MM-AAAA). Ej: 20-06-1991",
      "validation": "fecha_dmy",
      "save_as": "agenda.birthdate",
      "next": "AGENDA_NEW_PHONE"
    },
    {
      "id": "AGENDA_NEW_PHONE",
      "type": "input",
      "text": "Ingrese su n√∫mero de contacto (celular o WhatsApp). Ej: 09xxxxxxxx",
      "validation": "phone",
      "save_as": "agenda.phone",
      "next": "AGENDA_NEW_EMAIL"
    },
    {
      "id": "AGENDA_NEW_EMAIL",
      "type": "input",
      "text": "Ingrese su correo electr√≥nico (ej: xxxxx@mail.com). Si no tiene, escriba 'ninguno'.",
      "validation": "email_optional",
      "save_as": "agenda.email",
      "next": "AGENDA_SAVE_PROFILE"
    },
    {
      "id": "AGENDA_SAVE_PROFILE",
      "type": "message",
      "on_enter_hooks": [
        {"hook": "patient.create_or_update", "args": ["{agenda.dni}", "{agenda.full_name}", "{agenda.birthdate}", "{agenda.phone}", "{agenda.email}"]}
      ],
      "next": "AGENDA_SEDE"
    },
    {
      "id": "AGENDA_INPUT_FECHA",
      "type": "input",
      "text": "Ingrese la fecha que desea (DD-MM-AAAA)",
      "validation": "fecha_dmy",
      "save_as": "agenda.date",
      "next": "AGENDA_SEDE"
    },
    {
      "id": "AGENDA_SEDE",
      "type": "choice",
      "text": "¬øEn qu√© sede desea atenderse?",
      "options": [
        {"value": "1", "label": "Guayaquil", "next": "AGENDA_GYE_SLOTS"},
        {"value": "2", "label": "Milagro", "next": "AGENDA_MIL_SLOTS"},
        {"value": "0", "label": "Atr√°s", "next": "MENU_PRINCIPAL"},
        {"value": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ],
      "footer": "0 Atr√°s ¬∑ 9 Inicio ¬∑ 00 Humano"
    },
    {
      "id": "AGENDA_GYE_SLOTS",
      "type": "choice",
      "text": "Seleccione un horario disponible para Guayaquil:",
      "dynamic_options_from": "agenda.slots",
      "on_select": {"save_as": "agenda.selected_slot"},
      "on_select_next": "AGENDA_RESUMEN",
      "footer": "0 Atr√°s ¬∑ 9 Inicio ¬∑ 00 Humano"
    },
    {
      "id": "AGENDA_MIL_SLOTS",
      "type": "choice",
      "text": "Seleccione un horario disponible para Milagro:",
      "dynamic_options_from": "agenda.slots",
      "on_select": {"save_as": "agenda.selected_slot"},
      "on_select_next": "AGENDA_RESUMEN",
      "footer": "0 Atr√°s ¬∑ 9 Inicio ¬∑ 00 Humano"
    },
    {
      "id": "AGENDA_RESUMEN",
      "type": "choice",
      "text": "Resumen de cita:\nPaciente: {agenda.full_name}\nFecha: {agenda.date}\nHora: {agenda.selected_slot}\nSede: {agenda.sede}\n\n¬øConfirma?",
      "options": [
        {"value": "1", "label": "Confirmar", "next": "AGENDA_CONFIRMADA"},
        {"value": "2", "label": "Cambiar hora", "next": "AGENDA_SEDE"},
        {"value": "9", "label": "Cancelar", "next": "MENU_PRINCIPAL"}
      ],
      "footer": "0 Atr√°s ¬∑ 9 Inicio ¬∑ 00 Humano"
    },
    {
      "id": "AGENDA_CONFIRMADA",
      "type": "text",
      "on_enter_hooks": [
        {"hook": "appointment.save", "args": ["{agenda.dni}", "{agenda.date}", "{agenda.selected_slot}", "{agenda.sede}"]}
      ],
      "text": "‚úÖ Su cita ha sido registrada. Recibir√° recordatorio por WhatsApp o correo.",
      "next": "MENU_PRINCIPAL"
    },
{
  "version": "6.0",
  "globals": {
    "commands": { "back": "0", "home": "9" },
    "validations": {
      "dni": {"regex": "^[0-9]{10}$", "error": "C√©dula inv√°lida"},
      "telefono_ec": {"regex": "^(09[0-9]{8})$", "error": "Tel√©fono inv√°lido"},
      "email_opcional": {"regex": "^(\\S+@\\S+\\.\\S+|ninguno)$", "error": "Email inv√°lido"}
    }
  },
    "defaultStartNode": "MENU_PRINCIPAL",
    "version": "6.0",
    "globals": {
      "commands": { "back": "0", "home": "9" },
      "validations": {
        "dni": { "regex": "^[0-9]{10}$", "error": "C√©dula inv√°lida" },
        "fecha_dmy": { "regex": "^\\d{2}-\\d{2}-\\d{4}$", "error": "Fecha inv√°lida" },
        "telefono": { "regex": "^(09[0-9]{8})$", "error": "Tel√©fono inv√°lido" },
        "email_opcional": { "regex": "^(\\S+@\\S+\\.\\S+|ninguno)$", "error": "Email inv√°lido" },
        "nombre_completo": { "regex": ".+", "error": "Nombre inv√°lido" }
      },
    },
    "nodes": [
      {
        "id": "MENU_PRINCIPAL",
        "type": "choice",
        "text": "¬°Buen d√≠a/tarde/noche! Soy Ana, asistente virtual del Dr. David Guzm√°n. ¬øC√≥mo te ayudo hoy?",
        "options": [
          { "key": "1", "label": "M√°s informaci√≥n de servicios m√©dicos", "next": "INFO_SERVICIOS" },
          { "key": "2", "label": "Agendar cita m√©dica", "next": "AGENDA_DNI" },
          { "key": "3", "label": "Reagendar o cancelar", "next": "REAGENDAR_CANCELAR" },
          { "key": "4", "label": "Consultar cita m√©dica", "next": "CONSULTAR_CITA" },
          { "key": "5", "label": "Hablar con el Dr. Guzm√°n", "next": "CONTACTAR_DOCTOR" }
        ]
      },
      {
        "id": "INFO_SERVICIOS",
        "type": "choice",
        "text": "üåü *M√ÅS INFORMACI√ìN DE SERVICIOS*\n\nMis servicios m√©dicos tienen un valor de **$45**. La consulta dura aprox. 60 minutos. Durante la misma se realizan:\nüü¢ *Electrocardiograma (ECG)*\nüü¢ *Asesor√≠a nutricional + plan personalizado*\nüü¢ *Educaci√≥n en diabetes (paciente y familia)*\nüü¢ *Examen de Neuropat√≠a Diab√©tica y pie Diab√©tico*\nüü¢ *Valoraci√≥n de riesgo cardiovascular y renal*\n\nAtenci√≥n previa cita en *Guayaquil* y *Milagro*.\n\nElige una opci√≥n:",
        "options": [
          { "key": "1", "label": "Direcci√≥n Guayaquil", "next": "DIRECCION_GYE" },
          { "key": "2", "label": "Direcci√≥n Milagro", "next": "DIRECCION_MIL" },
          { "key": "0", "label": "Atr√°s", "command": "back" },
          { "key": "9", "label": "Inicio", "command": "home" }
        ]
      },
      {
        "id": "DIRECCION_GYE",
        "type": "choice",
        "text": "üìç *DIRECCI√ìN GUAYAQUIL*\nHospital de Especialidades (Torre Sur), Consultorio 204 (antigua Cl√≠nica Kennedy Alborada)\nüîó [Ver en Google Maps](https://maps.app.goo.gl/7J8v9V9RJHfxADfz7)",
        "options": [
          { "key": "1", "label": "Agendar Cita M√©dica", "next": "AGENDA_DNI" },
          { "key": "0", "label": "Atr√°s", "command": "back" },
          { "key": "9", "label": "Inicio", "command": "home" }
        ]
      },
      {
        "id": "DIRECCION_MIL",
        "type": "choice",
        "text": "üìç *DIRECCI√ìN MILAGRO*\nCl√≠nica Santa Elena, Av. Crist√≥bal Col√≥n y calle P.J. Montero\nüîó [Ver en Google Maps](https://maps.app.goo.gl/7hh97D7JDcznqRSK9)",
        "options": [
          { "key": "1", "label": "Agendar Cita M√©dica", "next": "AGENDA_DNI" },
          { "key": "0", "label": "Atr√°s", "command": "back" },
          { "key": "9", "label": "Inicio", "command": "home" }
        ]
      },
      {
        "id": "AGENDA_DNI",
        "type": "input",
        "text": "Por favor, ingresa tu c√©dula (10 d√≠gitos) o pasaporte:",
        "validation": "dni",
        "save_as": "agenda.dni",
        "hooks": [
          { "hook": "patient.lookup", "args": ["{agenda.dni}"], "if_true_next": "AGENDA_EXISTE_DIA", "if_false_next": "AGENDA_NEW_NAME" }
        ]
      },
      {
        "id": "AGENDA_EXISTE_DIA",
        "type": "choice",
        "text": "Bienvenido/a {agenda.patient.name}. Indique qu√© d√≠a desea ser atendido‚Ä¶",
        "options": [
          { "key": "1", "label": "Hoy", "hooks": [{ "hook": "dates_today", "save_as": "agenda.date" }], "next": "AGENDA_SEDE" },
          { "key": "2", "label": "Ma√±ana", "hooks": [{ "hook": "dates_tomorrow", "save_as": "agenda.date" }], "next": "AGENDA_SEDE" },
          { "key": "3", "label": "Otra fecha", "next": "AGENDA_INPUT_FECHA" },
          { "key": "0", "label": "Atr√°s", "command": "back" },
          { "key": "9", "label": "Inicio", "command": "home" }
        ]
      },
      {
        "id": "AGENDA_NEW_NAME",
        "type": "input",
        "text": "Escribir un nombre y dos apellidos (ej: Maria Lopez Garcia)",
        "validation": "nombre_completo",
        "save_as": "agenda.full_name",
        "next": "AGENDA_NEW_BIRTHDATE"
      },
      {
        "id": "AGENDA_NEW_BIRTHDATE",
        "type": "input",
        "text": "Ay√∫deme digitando su Fecha de nacimiento (DD‚ÄìMM‚ÄìAAAA)‚Ä¶",
        "validation": "fecha_dmy",
        "save_as": "agenda.birthdate",
        "next": "AGENDA_NEW_PHONE"
      },
      {
        "id": "AGENDA_NEW_PHONE",
        "type": "input",
        "text": "N√∫mero de contacto (09xxxxxxxx)‚Ä¶",
        "validation": "telefono",
        "save_as": "agenda.phone",
        "next": "AGENDA_NEW_EMAIL"
      },
      {
        "id": "AGENDA_NEW_EMAIL",
        "type": "input",
        "text": "Correo electr√≥nico‚Ä¶ o escriba 'ninguno'",
        "validation": "email_opcional",
        "save_as": "agenda.email",
        "next": "AGENDA_SAVE_PROFILE"
      },
      {
        "id": "AGENDA_SAVE_PROFILE",
        "type": "text",
        "on_enter_hooks": [ { "hook": "patient.create_or_update", "args": ["{agenda}"] } ],
        "next": "AGENDA_SEDE"
      },
      {
        "id": "AGENDA_INPUT_FECHA",
        "type": "input",
        "text": "Indique la fecha (DD‚ÄìMM‚ÄìAAAA)‚Ä¶",
        "validation": "fecha_dmy",
        "save_as": "agenda.date",
        "next": "AGENDA_SEDE"
      },
      {
        "id": "AGENDA_SEDE",
        "type": "choice",
        "text": "Seleccione la sede:",
        "options": [
          { "key": "1", "label": "Guayaquil", "next": "AGENDA_GYE_FECHA_MENU" },
          { "key": "2", "label": "Milagro", "next": "AGENDA_MIL_FECHA" },
          { "key": "0", "label": "Atr√°s", "command": "back" },
          { "key": "9", "label": "Inicio", "command": "home" }
        ]
      },
      {
        "id": "AGENDA_GYE_FECHA_MENU",
        "type": "choice",
        "text": "¬øPara qu√© d√≠a en Guayaquil?",
        "options": [
          { "key": "1", "label": "Hoy", "hooks": [{ "hook": "dates_today", "save_as": "agenda.date" }], "next": "AGENDA_GYE_SLOTS" },
          { "key": "2", "label": "Ma√±ana", "hooks": [{ "hook": "dates_tomorrow", "save_as": "agenda.date" }], "next": "AGENDA_GYE_SLOTS" },
          { "key": "3", "label": "Otra fecha", "next": "AGENDA_GYE_FECHA_INPUT" },
          { "key": "0", "label": "Atr√°s", "command": "back" },
          { "key": "9", "label": "Inicio", "command": "home" }
        ]
      },
      {
        "id": "AGENDA_GYE_FECHA_INPUT",
        "type": "input",
        "text": "Indique la fecha (DD‚ÄìMM‚ÄìAAAA)‚Ä¶",
        "validation": "fecha_dmy",
        "save_as": "agenda.date",
        "next": "AGENDA_GYE_SLOTS"
      },
      {
        "id": "AGENDA_GYE_SLOTS",
        "type": "choice",
        "text": "Seleccione un horario disponible:",
        "dynamic_options_from": "agenda.slots",
        "on_enter_hooks": [ { "hook": "agenda.fetch_slots", "args": ["GYE", "{agenda.date}"] } ],
        "on_select_save_as": "agenda.selected_slot",
        "on_select_next": "AGENDA_GYE_RESUMEN",
        "options": [
          { "key": "0", "label": "Atr√°s", "command": "back" },
          { "key": "9", "label": "Inicio", "command": "home" }
        ]
      },
      {
        "id": "AGENDA_GYE_RESUMEN",
        "type": "choice",
        "text": "Confirmar {agenda.date} {agenda.selected_slot} en Guayaquil?",
        "options": [
          { "key": "1", "label": "Confirmar", "next": "AGENDA_CONFIRMADO" },
          { "key": "2", "label": "Cambiar hora", "next": "AGENDA_GYE_SLOTS" },
          { "key": "9", "label": "Cancelar", "next": "MENU_PRINCIPAL" }
        ]
      },
      {
        "id": "AGENDA_CONFIRMADO",
        "type": "text",
        "on_enter_hooks": [ { "hook": "appointments.book_confirmed", "args": ["{agenda}"] } ],
        "text": "¬°Listo! Te confirmo tu cita.",
        "next": "MENU_PRINCIPAL"
      },
      {
        "id": "REAGENDAR_CANCELAR",
        "type": "text",
        "text": "Pronto aqu√≠ podr√°s reprogramar/cancelar. Por ahora, responde 2 para agendar.",
        "next": "MENU_PRINCIPAL"
      },
      {
        "id": "CONSULTAR_CITA",
        "type": "text",
        "text": "Pronto podr√°s consultar tu cita. Por ahora, responde 2 para agendar.",
        "next": "MENU_PRINCIPAL"
      },
      {
        "id": "CONTACTAR_DOCTOR",
        "type": "text",
        "text": "Si necesitas hablar con el Dr. Guzm√°n, responde 00 para derivaci√≥n humana.",
        "next": "MENU_PRINCIPAL"
      }
    ]
  }
  "nodes": [
    {
  "id": "MENU_PRINCIPAL",
  "type": "choice",
  "text": "Responde con el n√∫mero correspondiente a las siguientes opciones:",
  "options": [
        { "value": "1", "label": "M√°s informaci√≥n de servicios m√©dicos", "next": "INFO_SERVICIOS" },
        { "value": "2", "label": "Agendar cita m√©dica", "next": "AGENDA_DNI" },
        { "value": "3", "label": "Reagendar o cancelar", "next": "REAGENDAR_CANCELAR" },
        { "value": "4", "label": "Consultar cita m√©dica", "next": "CONSULTAR_CITA" },
        { "value": "5", "label": "Solicitar hablar con el Dr. Guzm√°n", "next": "CONTACTAR_DOCTOR" }
      ],
      "footer": "0 Atr√°s ¬∑ 9 Inicio ¬∑ 00 Humano"
    },
    {
      "id": "INFO_SERVICIOS",
      "type": "choice",
      "text": "üåü *M√ÅS INFORMACI√ìN DE SERVICIOS*\n\nMis servicios m√©dicos tienen un valor de *$45*. La consulta dura aprox. 60 minutos. Durante la misma se realizan:\n‚úÖ *Electrocardiograma (ECG)*\n‚úÖ *Asesor√≠a nutricional + plan personalizado*\n‚úÖ *Educaci√≥n en diabetes (paciente y familia)*\n‚úÖ *Examen de Neuropat√≠a Diab√©tica y pie Diab√©tico*\n‚úÖ *Valoraci√≥n de riesgo cardiovascular y renal*\n\nAtenci√≥n previa cita en *Guayaquil* y *Milagro*.\n\nA continuaci√≥n, elige la opci√≥n correspondiente:",
      "options": [
        { "value": "1", "label": "Direcci√≥n Guayaquil", "next": "DIRECCION_GYE" },
        { "value": "2", "label": "Direcci√≥n Milagro", "next": "DIRECCION_MIL" }
      ],
      "footer": "0 Atr√°s ¬∑ 9 Inicio ¬∑ 00 Humano"
    },
    {
      "id": "DIRECCION_GYE",
      "type": "choice",
      "text": "üìç *DIRECCI√ìN GUAYAQUIL*\nHospital de Especialidades (Torre Sur), Consultorio 204 (antigua Cl√≠nica Kennedy Alborada)\nüîó [Ver en Google Maps](https://maps.app.goo.gl/7J8v9V9RJHfxADfz7)",
      "options": [
        { "value": "1", "label": "Agendar Cita M√©dica", "next": "AGENDA_DNI" }
      ],
      "footer": "0 Atr√°s ¬∑ 9 Inicio ¬∑ 00 Humano"
    },
    {
      "id": "DIRECCION_MIL",
      "type": "choice",
      "text": "üìç *DIRECCI√ìN MILAGRO*\nCl√≠nica Santa Elena, Av. Crist√≥bal Col√≥n y calle P.J. Montero\nüîó [Ver en Google Maps](https://maps.app.goo.gl/7hh97D7JDcznqRSK9)",
      "options": [
        { "value": "1", "label": "Agendar Cita M√©dica", "next": "AGENDA_DNI" }
      ],
      "footer": "0 Atr√°s ¬∑ 9 Inicio ¬∑ 00 Humano"
    },
    {
      "id": "REAGENDAR_CANCELAR",
      "type": "text",
      "text": "üõ†Ô∏è Esta secci√≥n est√° en construcci√≥n. Por favor, intenta m√°s tarde.",
      "next": "MENU_PRINCIPAL",
      "footer": "0 Atr√°s ¬∑ 9 Inicio ¬∑ 00 Humano"
    },
    {
      "id": "CONSULTAR_CITA",
      "type": "text",
      "text": "üõ†Ô∏è Esta secci√≥n est√° en construcci√≥n. Por favor, intenta m√°s tarde.",
      "next": "MENU_PRINCIPAL",
      "footer": "0 Atr√°s ¬∑ 9 Inicio ¬∑ 00 Humano"
    },
    {
      "id": "CONTACTAR_DOCTOR",
      "type": "text",
      "text": "üõ†Ô∏è Esta secci√≥n est√° en construcci√≥n. Por favor, intenta m√°s tarde.",
      "next": "MENU_PRINCIPAL",
      "footer": "0 Atr√°s ¬∑ 9 Inicio ¬∑ 00 Humano"
    },
    {
      "id": "AGENDA_NEW_BIRTHDATE",
      "type": "input",
      "text": "Fecha de nacimiento (DD-MM-AAAA):",
      "validation": "fecha_dmy",
      "save_as": "agenda.birth_date",
      "next": "AGENDA_NEW_PHONE"
    },
    {
      "id": "AGENDA_NEW_PHONE",
      "type": "input",
      "text": "Telefono de contacto (09XXXXXXXX):",
      "validation": "telefono_ec",
      "save_as": "agenda.phone",
      "next": "AGENDA_NEW_EMAIL"
    },
    {
      "id": "AGENDA_NEW_EMAIL",
      "type": "input",
      "text": "Correo (opcional). Escribe 'ninguno' si no deseas ingresarlo:",
      "validation": "email_opcional",
      "save_as": "agenda.email",
      "next": "AGENDA_SAVE_PROFILE"
    },
    {
      "id": "AGENDA_SAVE_PROFILE",
      "type": "message",
      "text": "Gracias, actualice tus datos.",
      "hooks": [
        {
          "hook": "patient.create_or_update",
          "args": ["{agenda.dni}", "{agenda.full_name}", "{agenda.birth_date}", "{agenda.phone}", "{agenda.email}", "{meta.channel}", "{meta.user_id}"]
        }
      ],
      "next": "AGENDA_SEDE"
    },
    {
      "id": "AGENDA_SEDE",
      "type": "choice",
      "text": "Elige la sede para tu cita:",
      "options": [
        {
          "key": "1",
          "label": "Guayaquil (agenda inmediata)",
          "save": {"agenda.site": "GYE", "agenda.site_label": "Guayaquil"},
          "next": "AGENDA_GYE_FECHA_MENU"
        },
        {
          "key": "2",
          "label": "Milagro (confirmacion diferida)",
          "save": {"agenda.site": "MIL", "agenda.site_label": "Milagro"},
          "next": "AGENDA_MIL_FECHA"
        },
  {"key": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "AGENDA_GYE_FECHA_MENU",
      "type": "choice",
      "text": "Selecciona la fecha para tu cita en Guayaquil:",
      "options": [
        {
          "key": "1",
          "label": "Hoy",
          "hooks": [{"hook": "dates_today", "save_as": "agenda.date"}],
          "next": "AGENDA_GYE_SLOTS"
        },
        {
          "key": "2",
          "label": "Manana",
          "hooks": [{"hook": "dates_tomorrow", "save_as": "agenda.date"}],
          "next": "AGENDA_GYE_SLOTS"
        },
        {
          "key": "3",
          "label": "Otra fecha (DD-MM-AAAA)",
          "next": "AGENDA_GYE_FECHA_INPUT"
        },
  {"key": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "AGENDA_GYE_FECHA_INPUT",
      "type": "input",
      "text": "Ingresa la fecha en formato DD-MM-AAAA:",
      "validation": "fecha_dmy",
      "save_as": "agenda.date",
      "next": "AGENDA_GYE_SLOTS"
    },
    {
      "id": "AGENDA_GYE_SLOTS",
      "type": "choice",
      "text": "Horarios disponibles para {agenda.date} en Guayaquil:",
      "hooks": [
        {
          "hook": "appointments.list_slots",
          "args": ["{agenda.site}", "{agenda.date}"]
        }
      ],
      "dynamic_options_from": "agenda.slots",
      "on_select": {"save_as": "agenda.selected_slot"},
      "on_select_next": "AGENDA_GYE_RESUMEN",
      "fallback": {
        "message": "Por ahora no tengo horarios disponibles para esa fecha. Puedes elegir otra fecha o escribir 9 para volver al inicio."
      }
    },
    {
      "id": "AGENDA_GYE_RESUMEN",
      "type": "choice",
      "text": "Resumen de tu cita:\n\nFecha y hora: {agenda.display}\nSede: {agenda.site_label}\nPaciente: {agenda.patient.summary}\n\nConfirmo que mis datos son correctos y autorizo su uso para agendar y recordarme mi atencion medica por WhatsApp/correo. Este canal no reemplaza una emergencia (911).",
      "on_enter_hooks": [
        {"hook": "agenda.store_slot", "args": ["{agenda.selected_slot}"]}
      ],
      "options": [
        {"key": "1", "label": "Confirmar", "next": "AGENDA_REMINDER"},
        {"key": "2", "label": "Cambiar hora", "next": "AGENDA_GYE_SLOTS"},
        {"key": "9", "label": "Cancelar", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "AGENDA_REMINDER",
      "type": "choice",
      "text": "?Como prefieres recibir recordatorios?",
      "options": [
        {
          "key": "1",
          "label": "WhatsApp (recomendado)",
          "save": {"agenda.reminder": "wa"},
          "hooks": [
            {"hook": "appointments.book_confirmed", "args": ["wa"], "save_as": "agenda.appointment_id"}
          ],
          "next": "AGENDA_CONFIRMACION"
        },
        {
          "key": "2",
          "label": "Correo electronico",
          "save": {"agenda.reminder": "email"},
          "hooks": [
            {"hook": "appointments.book_confirmed", "args": ["email"], "save_as": "agenda.appointment_id"}
          ],
          "next": "AGENDA_CONFIRMACION"
        },
  {"key": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "AGENDA_CONFIRMACION",
      "type": "message",
      "text": "Listo. Tu cita quedo para {agenda.display} en {agenda.site_label}.\n\nDireccion: Hospital de Especialidades (Torre Sur), consultorio 204 (antigua Clinica Kennedy Alborada).\nMapa: https://maps.app.goo.gl/7J8v9V9RJHfxADfz7\n\nTe enviaremos recordatorios. Si necesitas cambiarla o cancelar, responde por este medio.",
      "next": "MENU_PRINCIPAL"
    },
    {
      "id": "AGENDA_MIL_FECHA",
      "type": "choice",
      "text": "Selecciona la fecha preferida para Milagro:",
      "options": [
        {
          "key": "1",
          "label": "Hoy",
          "hooks": [{"hook": "dates_today", "save_as": "agenda.mil_date"}],
          "next": "AGENDA_MIL_TURNO"
        },
        {
          "key": "2",
          "label": "Manana",
          "hooks": [{"hook": "dates_tomorrow", "save_as": "agenda.mil_date"}],
          "next": "AGENDA_MIL_TURNO"
        },
        {
          "key": "3",
          "label": "Otra fecha (DD-MM-AAAA)",
          "next": "AGENDA_MIL_FECHA_INPUT"
        },
        {"key": "9", "label": "Volver", "next": "AGENDA_SEDE"}
      ]
    },
    {
      "id": "AGENDA_MIL_FECHA_INPUT",
      "type": "input",
      "text": "Ingresa la fecha en formato DD-MM-AAAA:",
      "validation": "fecha_dmy",
      "save_as": "agenda.mil_date",
      "next": "AGENDA_MIL_TURNO"
    },
    {
      "id": "AGENDA_MIL_TURNO",
      "type": "choice",
      "text": "Selecciona la franja horaria preferida en Milagro:",
      "options": [
        {
          "key": "1",
          "label": "Manana (09:00-12:00)",
          "save": {"agenda.mil_shift": "manana"},
          "next": "AGENDA_MIL_REGISTRO"
        },
        {
          "key": "2",
          "label": "Tarde (15:00-18:00)",
          "save": {"agenda.mil_shift": "tarde"},
          "next": "AGENDA_MIL_REGISTRO"
        },
        {"key": "9", "label": "Volver", "next": "AGENDA_MIL_FECHA"}
      ]
    },
    {
      "id": "AGENDA_MIL_REGISTRO",
      "type": "message",
      "hooks": [
        {
          "hook": "appointments.register_milagro",
          "args": ["{agenda.mil_date}", "{agenda.mil_shift}"],
          "save_as": "agenda.appointment_id"
        }
      ],
      "text": "Solicitud registrada. Nuestro equipo confirmara disponibilidad y te contactara por este medio.",
      "next": "AGENDA_MIL_CONFIRMACION"
    },
    {
      "id": "AGENDA_MIL_CONFIRMACION",
      "type": "message",
      "text": "Milagro: Clinica Santa Elena, Av. Cristobal Colon y Calle Gral. PJ Montero.\nMapa: https://maps.app.goo.gl/7hh97D7JDcznqRSK9\n\nEn cuanto confirmemos horario te escribiremos. Gracias por la confianza.",
      "next": "MENU_PRINCIPAL"
    },
    
    {
      "id": "INFO_CONSULTA",
      "type": "choice",
      "text": "La consulta dura 60 minutos y tiene un valor de 45 dolares. Revisamos tu historia, aclaramos dudas y definimos un plan para controlar tu condicion y mejorar tu calidad de vida. Incluye ECG, asesoria nutricional con plan, educacion en diabetes (para ti y tu familia), examen de neuropatia diabetica y valoracion del riesgo cardiovascular/renal.",
      "options": [
        {"key": "1", "label": "Agendar cita", "next": "AGENDA_DNI"},
        {"key": "2", "label": "Ver ubicaciones", "next": "UBICACIONES"},
  {"key": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "INFO_NEUROPATIA",
      "type": "choice",
      "text": "Si presentas hormigueo, ardor, entumecimiento o dolor en pies/manos, evaluamos el grado de neuropatia y ajustamos tu tratamiento. Te orientamos en medicacion, habitos, cuidado de pies y senales de alarma, con un plan claro para tu dia a dia.",
      "options": [
        {"key": "1", "label": "Agendar cita", "next": "AGENDA_DNI"},
        {"key": "2", "label": "Ver ubicaciones", "next": "UBICACIONES"},
  {"key": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "INFO_PIE",
      "type": "choice",
      "text": "Las curaciones de pie diabetico estan incluidas dentro de la consulta. Si se requiere material avanzado o procedimientos adicionales, te lo explicamos y solicitamos autorizacion antes de continuar.",
      "options": [
        {"key": "1", "label": "Agendar cita", "next": "AGENDA_DNI"},
        {"key": "2", "label": "Ver ubicaciones", "next": "UBICACIONES"},
  {"key": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "PRECIOS",
      "type": "choice",
      "text": "Consulta $45 (incluye ECG, plan nutricional, educacion en diabetes, examen de neuropatia y valoracion de riesgo, ademas de curaciones de pie diabetico). Material o procedimientos avanzados: segun necesidad y con autorizacion previa.",
      "options": [
        {"key": "1", "label": "Agendar cita", "next": "AGENDA_DNI"},
        {"key": "2", "label": "Ver ubicaciones", "next": "UBICACIONES"},
  {"key": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "UBICACIONES",
      "type": "choice",
      "text": "Guayaquil: Hospital de Especialidades (Torre Sur), consultorio 204 (antigua Clinica Kennedy Alborada).\nMapa: https://maps.app.goo.gl/7J8v9V9RJHfxADfz7\n\nMilagro: Clinica Santa Elena, Av. Cristobal Colon y Calle Gral. PJ Montero.\nMapa: https://maps.app.goo.gl/7hh97D7JDcznqRSK9",
      "options": [
        {"key": "1", "label": "Agendar cita", "next": "AGENDA_DNI"},
  {"key": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "REA_DNI",
      "type": "input",
      "text": "Para buscar tu cita escribe tu cedula/pasaporte:",
      "validation": "dni",
      "save_as": "agenda.dni",
      "hooks": [
        {
          "hook": "appointments.upcoming_by_dni",
          "args": ["{agenda.dni}"],
          "if_true_next": "REA_RESUMEN",
          "if_false_next": "REA_SIN_CITA"
        }
      ]
    },
    {
      "id": "REA_SIN_CITA",
      "type": "choice",
      "text": "No encontre citas activas con ese documento.\n\n?Deseas agendar una nueva cita?",
      "options": [
        {"key": "1", "label": "Si, agendar", "next": "AGENDA_SEDE"},
  {"key": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "REA_RESUMEN",
      "type": "choice",
      "text": "Tu proxima cita: {appointments.target.local_label} en {appointments.target.site_label}.\nEstado: {appointments.target.status}.\n\n?Que deseas hacer?",
      "options": [
        {"key": "1", "label": "Reagendar", "next": "REA_RES_FECHA_MENU"},
        {"key": "2", "label": "Cancelar", "next": "REA_CANCEL_MOTIVO"},
  {"key": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "REA_RES_FECHA_MENU",
      "type": "choice",
      "text": "Selecciona la nueva fecha para tu cita:",
      "options": [
        {
          "key": "1",
          "label": "Hoy",
          "hooks": [{"hook": "dates_today", "save_as": "agenda.date"}],
          "next": "REA_RES_SLOTS"
        },
        {
          "key": "2",
          "label": "Manana",
          "hooks": [{"hook": "dates_tomorrow", "save_as": "agenda.date"}],
          "next": "REA_RES_SLOTS"
        },
        {
          "key": "3",
          "label": "Otra fecha (DD-MM-AAAA)",
          "next": "REA_RES_FECHA_INPUT"
        },
        {"key": "9", "label": "Volver", "next": "REA_RESUMEN"}
      ]
    },
    {
      "id": "REA_RES_FECHA_INPUT",
      "type": "input",
      "text": "Ingresa la nueva fecha (DD-MM-AAAA):",
      "validation": "fecha_dmy",
      "save_as": "agenda.date",
      "next": "REA_RES_SLOTS"
    },
    {
      "id": "REA_RES_SLOTS",
      "type": "choice",
      "text": "Horarios disponibles para {agenda.date}:",
      "hooks": [
        {
          "hook": "appointments.list_slots",
          "args": ["{agenda.site}", "{agenda.date}"]
        }
      ],
      "dynamic_options_from": "agenda.slots",
      "on_select": {"save_as": "agenda.selected_slot"},
      "on_select_next": "REA_RES_CONFIRM",
      "fallback": {
        "message": "No tengo disponibilidad en esa fecha. Puedes intentar con otra fecha o escribir 9 para volver."
      }
    },
    {
      "id": "REA_RES_CONFIRM",
      "type": "choice",
      "text": "Confirmas reagendar tu cita a {agenda.display} en {agenda.site_label}?",
      "on_enter_hooks": [
        {"hook": "agenda.store_slot", "args": ["{agenda.selected_slot}"]}
      ],
      "options": [
        {
          "key": "1",
          "label": "Confirmar",
          "hooks": [
            {
              "hook": "appointments.reschedule",
              "args": ["{appointments.target.id}", "{agenda.selected_slot}"]
            }
          ],
          "next": "REA_RES_DONE"
        },
        {"key": "2", "label": "Elegir otra hora", "next": "REA_RES_SLOTS"},
        {"key": "9", "label": "Volver", "next": "REA_RESUMEN"}
      ]
    },
    {
      "id": "REA_RES_DONE",
      "type": "message",
      "text": "Actualizado. Tu nueva cita es {agenda.display} en {agenda.site_label}.",
      "next": "MENU_PRINCIPAL"
    },
    {
      "id": "REA_CANCEL_MOTIVO",
      "type": "input",
      "text": "Si deseas, escribe el motivo de la cancelacion (o deja en blanco):",
      "save_as": "appointments.cancel_reason",
      "next": "REA_CANCEL_CONFIRM"
    },
    {
      "id": "REA_CANCEL_CONFIRM",
      "type": "choice",
      "text": "Confirmas cancelar la cita {appointments.target.local_label} en {appointments.target.site_label}?",
      "options": [
        {
          "key": "1",
          "label": "Cancelar",
          "hooks": [
            {"hook": "appointments.cancel", "args": ["{appointments.target.id}"]}
          ],
          "next": "REA_CANCEL_DONE"
        },
        {"key": "2", "label": "No, conservar", "next": "REA_RESUMEN"}
      ]
    },
    {
      "id": "REA_CANCEL_DONE",
      "type": "choice",
      "text": "Cita cancelada. ?Deseas agendar otra fecha?",
      "options": [
        {"key": "1", "label": "Si, agendar", "next": "AGENDA_SEDE"},
  {"key": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "PORTAL",
      "type": "choice",
      "text": "El Portal del Paciente estara disponible pronto. Mientras tanto puedo ayudarte a agendar, reagendar o cancelar por este canal.",
      "options": [
        {"key": "1", "label": "Agendar cita", "next": "AGENDA_DNI"},
        {"key": "5", "label": "Reagendar o cancelar", "next": "REA_DNI"},
        {"key": "9", "label": "Inicio", "next": "MENU_PRINCIPAL"}
      ]
    },
    {
      "id": "CONTACTO",
      "type": "choice",
      "text": "Puedes escribir 0 en cualquier momento para que te conecte con un asesor humano. Tambien puedo ayudarte a agendar una cita con el Dr. Guzman.",
      "options": [
        {"key": "1", "label": "Agendar cita", "next": "AGENDA_DNI"},
        {"key": "2", "label": "Ver opciones", "next": "HOME"}
      ]
    }
  ]
}


